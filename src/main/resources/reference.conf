// Template sentinels:
// release_uri â€” used in common.path

spark_uri: null

common: {
  additional_outputs: []
  output_format: "parquet"
  path: "gs://open-targets-pre-data-releases/etl_test"
  output_path: "gs://open-targets-pre-data-releases/etl_test"
}

spark_settings: {
  write_mode: "overwrite"  # in orchestrator we trust

  default_spark_session_config: [
    { k: "spark.driver.maxResultSize",    v: "0"    }
    { k: "spark.debug.maxToStringFields", v: "2000" }
    { k: "spark.sql.broadcastTimeout",    v: "3000" }
  ]
}

# ============================= STEP CONFIGURATION =============================
steps: {
  reactome: {
    input: {
      pathways: {
        format: "csv"
        path: ${common.path}"/input/reactome/ReactomePathways.txt"
        options: [
          { k: "sep",         v: "\\t" }
          { k: "header",      v: false }
          { k: "inferSchema", v: true  }
        ]
      }
      relations: {
        format: "csv"
        path: ${common.path}"/input/reactome/ReactomePathwaysRelation.txt"
        options: [
          { k: "sep",         v: "\\t" }
          { k: "header",      v: false }
          { k: "inferSchema", v: true  }
        ]
      }
    }
    output: {
      reactome: {
        format: ${common.output_format}
        path: ${common.output_path}"/intermediate/reactome"
      }
    }
  }

  pharmacogenomics: {
    input: {
      pgx: {
        format: "parquet"
        path: ${common.path}"/intermediate/pharmacogenetics.parquet"
      }
      drug: ${steps.drug.output.drug}
    }
    output: {
      pgx: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/pharmacogenomics"
      }
    }
  }

  expression: {
    input: {
      rna: {
        format: "csv"
        path: ${common.path}"/input/expression/baseline_expression_counts.tsv"
        options: [
          { k: "sep",         v: "\\t" }
          { k: "header",      v: true  }
          { k: "inferSchema", v: true  }
        ]
      }
      binned: {
        format: "csv"
        path: ${common.path}"/input/expression/baseline_expression_binned.tsv"
        options: [
          { k: "sep",         v: "\\t" }
          { k: "header",      v: true  }
          { k: "inferSchema", v: true  }
        ]
      }
      zscore: {
        format: "csv"
        path: ${common.path}"/input/expression/baseline_expression_zscore_binned.tsv"
        options: [
          { k: "sep",         v: "\\t" }
          { k: "header",      v: true  }
          { k: "inferSchema", v: true  }
        ]
      }
      exprhierarchy: {
        format: "csv"
        path: ${common.path}"/input/expression/expression_hierarchy_curation.tsv"
        options: [
          { k: "sep",         v: "\\t" }
          { k: "header",      v: false }
          { k: "inferSchema", v: true  }
        ]
      }
      efomap: {
        format: "parquet"
        path: ${common.path}"/intermediate/expression/tissue-translation-map.parquet"
      }
      tissues: {
        format: "csv"
        path: ${common.path}"/intermediate/expression/normal_tissue.tsv.gz"
        options: [
          { k: "sep",         v: "\\t" }
          { k: "header",      v: true  }
          { k: "inferSchema", v: true  }
        ]
      }
    }
    output: {
      expression: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/expression"
      }
    }
  }

  interaction: {
    scorethreshold: 0
    string_version: "12"
    input: {
      targets: ${steps.target.output.target}
      rnacentral: {
        format: "csv"
        path: ${common.path}"/input/interaction/rna_central_ensembl.tsv"
        options: [
          { k: "sep",    v: "\\t" }
          { k: "header", v: false }
        ]
      }
      humanmapping: {
        format: "csv"
        path: ${common.path}"/input/interaction/HUMAN_9606_idmapping.dat.gz"
        options: [
          { k: "sep",    v: "\\t" }
          { k: "header", v: false }
        ]
      }
      ensproteins: {
        format: "csv"
        path: ${common.path}"/input/interaction/Homo_sapiens.GRCh38.chr.gtf.gz"
        options: [
          { k: "sep",     v: "\\t" }
          { k: "header",  v: false }
          { k: "comment", v: "#"   }
        ]
      }
      intact: {
        format: "json"
        path: ${common.path}"/input/interaction/intact-interactors.json"
      }
      strings: {
        format: "csv"
        path: ${common.path}"/input/interaction/string-interactions.txt.gz"
        options: [
          { k: "sep",    v: " "  }
          { k: "header", v: true }
        ]
      }
    }
    output: {
      interactions: {
        format: ${common.output_format}
        path: ${common.path}"/output/interaction"
      }
      interactions_evidence: {
        format: ${common.output_format}
        path: ${common.path}"/output/interaction_evidence"
      }
      interactions_unmatched: {
        format: ${common.output_format}
        path: ${common.path}"/excluded/interaction"
      }
    }
  }

  target: {
    input: {
      chembl: {
        format: "json"
        path: ${common.path}"/input/target/chembl/chembl_target.jsonl"
      }
      chemical_probes: {
        format: "parquet"
        path: ${common.path}"/intermediate/chemical_probes_evidence.parquet"
      }
      diseases: {
        format: "parquet"
        path: ${common.path}"/output/disease"
      }
      ensembl: {
        format: ${common.output_format}
        path: ${common.path}"/intermediate/target/ensembl/homo_sapiens.parquet"
      }
      gene_code: {
        format: "csv"
        path: ${common.path}"/input/target/gencode/gencode.gff3.gz"
        options: [
          { k: "sep",     v: "\\t" }
          { k: "comment", v: "#"   }
        ]
      }
      genetic_constraints: {
        format: "csv"
        path: ${common.path}"/input/target/gnomad/gnomad_constraint_metrics.tsv"
        options: [
          { k: "sep",       v: "\\t" }
          { k: "header",    v: true  }
          { k: "nullValue", v: "NA"  }
        ]
      }
      gene_ontology_human: {
        format: "csv"
        path: ${common.path}"/input/target/go/goa_human.gaf.gz"
        options: [
          { k: "sep",     v: "\\t" }
          { k: "comment", v: "!"   }
        ]
      }
      gene_ontology_rna: {
        format: "csv"
        path: ${common.path}"/input/target/go/goa_human_rna.gaf.gz"
        options: [
          { k: "sep", v: "\\t"   }
          { k: "comment", v: "!" }
        ]
      }
      gene_ontology_rna_lookup: {
        format: "csv"
        path: ${common.path}"/input/target/go/ensembl.tsv"
        options: [
          { k: "sep", v: "\\t" }
        ]
      }
      gene_ontology_eco_lookup: {
        format: "csv"
        path: ${common.path}"/input/target/go/goa_human_eco.gpa.gz"
        options: [
          { k: "sep", v: "\\t"   }
          { k: "comment", v: "!" }
        ]
      }
      hallmarks: {
        format: "csv"
        path: ${common.path}"/input/target/hallmarks/cosmic-hallmarks.tsv.gz"
        options: [
          { k: "sep",    v: "\\t" }
          { k: "header", v: true  }
        ]
      }
      hgnc: {
        format: "json"
        path: ${common.path}"/input/target/genenames/hgnc_complete_set.json"
      },
      homology_dictionary: {
        format: "csv"
        path: ${common.path}"/input/target/homologue/species_EnsemblVertebrates.txt"
        options: [
          { k: "sep",    v: "\\t" }
          { k: "header", v: true  }
        ]
      }
      homology_coding_proteins: {
        format: "csv"
        path: ${common.path}"/input/target/homologue/homologies/*.tsv.gz"
        options: [
          { k: "sep",    v: "\\t" }
          { k: "header", v: true  }
        ]
      }
      homology_gene_dictionary: {
        format: "parquet"
        path: ${common.path}"/intermediate/target/homologue/gene_dictionary/*.parquet"
        options: [
          { k: "sep", v: "\\t" }
        ]
      }
      hpa: {
        format: "csv"
        path: ${common.path}"/intermediate/target/hpa/subcellular_location.tsv.gz"
        options: [
          { k: "sep",    v: "\\t" }
          { k: "header", v: true  }
        ]
      }
      hpa_sl: {
        format: "parquet"
        path: ${common.path}"/intermediate/target/hpa/subcellular_locations_ssl.parquet"
      }
      ncbi: {
        format: "csv"
        path: ${common.path}"/input/target/ncbi/Homo_sapiens.gene_info.gz"
        options: [
          { k: "sep",    v: "\\t" }
          { k: "header", v: true  }
        ]
      }
      project_scores_ids: {
        format: "parquet"
        path: ${common.path}"/intermediate/target/project-scores/gene_identifiers_latest.parquet"
      }
      project_scores_essentiality_matrix: {
        format: "parquet"
        path: ${common.path}"/intermediate/target/project-scores/04_binaryDepScores.parquet"
      }
      reactome_etl: {
        format: "parquet"
        path: ${common.path}"/intermediate/reactome/part*"
      }
      reactome_pathways: {
        format: "csv"
        path: ${common.path}"/input/target/reactome/Ensembl2Reactome.txt"
        options: [
          { k: "sep", v: "\\t" }
        ]
      }
      safety_evidence: {
        format: "parquet"
        path: ${common.path}"/intermediate/target/safety.parquet"
      }
      tep: {
        format: "json"
        path: ${common.path}"/input/target/tep/tep.json.gz"
      },
      tractability: {
        format: "csv"
        path: ${common.path}"/input/target/tractability/tractability.tsv"
        options: [
          { k: "sep",    v: "\\t" }
          { k: "header", v: true  }
        ]
      }
      uniprot: {
        format: "txt"
        path: ${common.path}"/input/target/uniprot/uniprot.txt.gz"
      }
      uniprot_ssl: {
        format: "csv"
        path: ${common.path}"/input/target/uniprot/uniprot-ssl.tsv.gz"
        options: [
          { k: "sep",    v: "\\t" }
          { k: "header", v: true  }
        ]
      }
      gene_essentiality: {
        format: "parquet"
        path: ${common.path}"/intermediate/target/gene-essentiality/essentiality.parquet"
      }
    }
    output: {
      target: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/target"
      }
      gene_essentiality: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/target_essentiality"
      }
    }
    hgnc_ortholog_species: [
      "9606-human"
      "9598-chimpanzee"
      "9544-macaque"
      "10090-mouse"
      "10116-rat"
      "9986-rabbit"
      "10141-guineapig"
      "9615-dog"
      "9823-pig"
      "8364-frog"
      "7955-zebrafish"
      "7227-fly"
      "6239-worm"
    ]
  }

  drug: {
    input: {
      chemical_probes: {
        format: "parquet"
        path: ${common.path}"/intermediate/chemical_probes_evidence.parquet"
      }
      chembl_indication: {
        format: "json"
        path: ${common.path}"/input/drug/chembl_drug_indication.jsonl"
      }
      chembl_molecule: {
        format: "json"
        path: ${common.path}"/input/drug/chembl_molecule.jsonl"
      }
      chembl_mechanism: {
        format: "json"
        path: ${common.path}"/input/drug/chembl_mechanism.jsonl"
      }
      chembl_target: {
        format: "json"
        path: ${common.path}"/input/drug/chembl_target.jsonl"
      }
      chembl_warning: {
        format: "json"
        path: ${common.path}"/input/drug/chembl_drug_warning.jsonl"
      }
      disease_etl: {
        format: "parquet"
        path: ${common.path}"/output/disease"
      }
      target_etl: ${steps.target.output.target}
      drugbank_to_chembl: {
        format: "csv"
        path: ${common.path}/input/drug/drugbank.csv.gz
        options: [
          { k: "sep",    v: "\\t" }
          { k: "header", v: true  }
        ]
      }
    }
    drug_extensions: []
    output: {
      drug: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/drug_molecule"
      }
      mechanism_of_action: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/drug_mechanism_of_action"
      }
      indications: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/drug_indication"
      }
      warnings: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/drug_warning"
      }
    }
  }

  known_drug: {
    input: {
      evidences: {
        format: ${common.output_format}
        path: ${common.path}"/output/evidence_chembl"
      }
      diseases: {
        format: "parquet"
        path: ${common.path}"/output/disease"
      }
      targets: ${steps.target.output.target}
      drug: ${steps.drug.output.drug}
      mechanism: ${steps.drug.output.mechanism_of_action}
    }
    output: {
      known_drugs: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/known_drug"
      }
    }
  }

  search_facet: {
    input: {
      diseases: {
        format: "parquet"
        path: ${common.path}"/output/disease"
      }
      targets: ${steps.target.output.target}
      go: ${steps.go.output.go}
    }
    output: {
      targets: {
        format: ${common.output_format}
        path: ${common.output_path}"/view/search_facet_target"
      }
      diseases: {
        format: ${common.output_format}
        path: ${common.output_path}"/view/search_facet_disease"
      }
    }
    categories: {
      disease_name: "Disease"
      therapeutic_area: "Therapeutic Area"
      sm: "Tractability Small Molecule"
      ab: "Tractability Antibody"
      pr: "Tractability PROTAC"
      oc: "Tractability Other Modalities"
      target_id: "Target ID"
      approved_symbol: "Approved Symbol"
      approved_name: "Approved Name"
      subcellular_location: "Subcellular Location"
      target_class: "ChEMBL Target Class"
      pathways: "Reactome"
      go_f: "GO:MF"
      go_p: "GO:BP"
      go_c: "GO:CC"
    }
  }

  go: {
    input: {
      go: {
        format: "csv"
        path: ${common.path}"/input/go/go.obo"
      }
    }
    output: {
      go: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/go"
      }
    }
  }

  search: {
    input: {
      association: {
        format: ${common.output_format}
        path: ${common.path}"/output/association_overall_indirect"
      }
      drug: ${steps.drug.output.drug}
      evidence: {
        format: ${common.output_format}
        path: ${common.path}"/output/evidence_*"
      }
      indication: ${steps.drug.output.indications}
      mechanism: ${steps.drug.output.mechanism_of_action}
      target: ${steps.target.output.target}
      credible_sets: {
        format: "parquet"
        path: ${common.path}"/output/credible_set"
      }
      disease: {
        format: "parquet"
        path: ${common.path}"/output/disease"
      }
      disease_hpo: {
        format: "parquet"
        path: ${common.path}"/output/disease_phenotype"
      }
      hpo: {
        format: "parquet"
        path: ${common.path}"/output/disease_hpo"
      }
      studies: {
        format: "parquet"
        path: ${common.path}"/output/study"
      }
      variants: {
        format: "parquet"
        path: ${common.path}"/output/variant"
      }
    }
    output: {
      diseases: {
        format: ${common.output_format}
        path: ${common.output_path}"/view/search_disease"
      }
      drugs: {
        format: ${common.output_format}
        path: ${common.output_path}"/view/search_drug"
      }
      studies: {
        format: ${common.output_format}
        path: ${common.output_path}"/view/search_study"
      }
      targets: {
        format: ${common.output_format}
        path: ${common.output_path}"/view/search_target"
      }
      variants: {
        format: ${common.output_format}
        path: ${common.output_path}"/view/search_variant"
      }
    }
  }

  openfda: {
    input: {
      chembl_drugs: ${steps.drug.output.drug}
      blacklisted_events: {
        format: "csv"
        path: ${common.path}"/input/openfda/blacklisted_events.txt"
        options: [
          { k: "sep",                      v: "\\t" }
          { k: "ignoreLeadingWhiteSpace",  v: true  }
          { k: "ignoreTrailingWhiteSpace", v: true  }
        ]
      }
      fda_data: {
        format: ${common.output_format}
        path: ${common.path}"/intermediate/openfda/*"
      }
      meddra_preferred_terms: {
        format: "csv"
        path: "gs://open-targets-data-releases-private/meddra/meddra23.1/MedAscii/pt.asc"
      }
      meddra_low_level_terms: {
        format: "csv"
        path: "gs://open-targets-data-releases-private/meddra/meddra23.1/MedAscii/llt.asc"
      }
    }
    output: {
      fda_unfiltered: {
        format: ${common.output_format}
        path: ${common.output_path}"/intermediate/openfda_adverse_drug_reactions"
      }
      fda_results: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/openfda_significant_adverse_drug_reactions"
      }
      fda_targets_unfiltered: {
        format: ${common.output_format}
        path: ${common.output_path}"/intermediate/openfda_adverse_target_reactions"
      }
      fda_targets_results: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/openfda_significant_adverse_target_reactions"
      }
      sampling: {
        format: ${common.output_format}
        path: ${common.output_path}"/intermediate/openfda_sample"
      }
      sampling_targets: {
        format: ${common.output_format}
        path: ${common.output_path}"/intermediate/openfda_sample_targets"
      }
    }
    meddra_preferred_terms_cols: [
      "pt_code"
      "pt_name"
    ]
    meddra_low_level_terms_cols: [
      "llt_code"
      "llt_name"
    ]
    montecarlo: {
      permutations: 100
      percentile: 0.95
    }
    sampling: {
      size: 0.1
      enabled: false
    }
  }

  search_ebi: {
    input: {
      disease: {
        format: "parquet"
        path: ${common.path}"/output/disease"
      }
      target: ${steps.target.output.target}
      evidence: {
        format: ${common.output_format}
        path: ${common.path}"/output/evidence_gwas_credible_sets"
      }
      association: {
        format: ${common.output_format}
        path: ${common.path}"/output/association_overall_direct"
      }
    }
    output: {
      associations: {
        format: ${common.output_format}
        path: ${common.output_path}"/view/search_ebi_associations"
      }
      evidence: {
        format: ${common.output_format}
        path: ${common.output_path}"/view/search_ebi_evidence"
      }
    }
  }

  otar: {
    input: {
      diseases: {
        format: "parquet"
        path: ${common.path}"/output/disease"
      }
      otar_meta: {
        format: "csv"
        path: ${common.path}"/input/otar/otar_meta.csv"
        options: [
          { k: "sep",         v: ","  }
          { k: "header",      v: true }
          { k: "inferSchema", v: true }
        ]
      }
      otar_project_to_efo: {
        format: "csv"
        path: ${common.path}"/input/otar/otar_project_to_efo.csv"
        options: [
          { k: "sep",         v: ","  }
          { k: "header",      v: true }
          { k: "inferSchema", v: true }
        ]
      }
    }
    output: {
      otar: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/otar"
      }
    }
  }

  literature: {
    input: {
      processing_epmcids: {
        format: "csv"
        path: ${common.path}"/input/literature/PMID_PMCID_DOI.csv.gz"
        options: [
          { k: "header",      v: true }
          { k: "inferSchema", v: true }
        ]
      }
      processing_diseases: {
        format: "parquet"
        path: ${common.path}"/output/disease"
      }
      processing_targets: ${steps.target.output.target}
      processing_drugs: ${steps.drug.output.drug}
      processing_abstracts: {
        format: "json"
        path: "gs://otar025-epmc/ml02/abstract/**/*.jsonl"
      }
      processing_full_texts: {
        format: "json"
        path: "gs://otar025-epmc/ml02/fulltext/**/*.jsonl"
      }
      epmc_cooccurences: ${steps.literature.output.processing_cooccurrences}
      embedding_matches: ${steps.literature.output.processing_matches}
      vectors_input: ${steps.literature.output.embedding_model}
    }
    output: {
      processing_cooccurrences: {
        format: ${common.output_format}
        path: ${common.output_path}"/intermediate/literature_cooccurrence"
      }
      processing_matches: {
        format: ${common.output_format}
        path: ${common.output_path}"/intermediate/literature_match"
      }
      processing_literature_index: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/literature"
      }
      processing_literature_sentences: {
        format: ${common.output_format}
        path: ${common.output_path}"/intermediate/literature_sentence"
      }
      processing_failed_cooccurrences: {
        format: ${common.output_format}
        path: ${common.output_path}"/excluded/literature_cooccurrence"
      }
      processing_failed_matches: {
        format: ${common.output_format}
        path: ${common.output_path}"/excluded/literature_match"
      }
      epmc_cooccurrences: {
        format: ${common.output_format}
        path: ${common.output_path}"/intermediate/literature_epmc_cooccurrence"
      }
      epmc_output: {
        format: "json"
        path: ${common.output_path}"/intermediate/evidence/literature_epmc"
        options: [
          { k: "compression", v: "gzip" }
        ]
      }
      embedding_model: {
        format: ${common.output_format}
        path: ${common.output_path}"/etc/model/w2v_model"
      }
      embedding_training_set: {
        format: ${common.output_format}
        path: ${common.output_path}"/intermediate/literature_training_set"
      }
      vectors_output: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/literature_vector"
      }
    }
    common: {
      publication_section_ranks: [
        { section: "title",    rank: 1, weight: 1.0 }
        { section: "abstract", rank: 1, weight: 0.8 }
        { section: "concl",    rank: 1, weight: 0.7 }
        { section: "results",  rank: 2, weight: 0.6 }
        { section: "discuss",  rank: 2, weight: 0.5 }
        { section: "methods",  rank: 3, weight: 0.3 }
        { section: "other",    rank: 4, weight: 0.1 }
      ]

      spark_session_config: [
        { k: "spark.sql.mapKeyDedupPolicy", v: "LAST_WIN" }
      ]
    }
    processing: {
      # When preparing the literature outputs we can optionally save all the
      # entities which did not match. These are not used for anything downstream
      # and are only useful for debugging and quality control. Setting this value
      # to true will result in additional outputs 'failedMatches' and 'failedCoocs'
      # being written. Note, this slows down the process significantly.
      write_failures: false
    }
    epmc: {
      uris: {
        ensembl: "https://www.ensembl.org/Homo_sapiens/Gene/Summary?db=core;g="
        chembl: "https://www.ebi.ac.uk/chembl/compound_report_card/"
        ontologies: "https://www.ebi.ac.uk/ols/ontologies/efo/terms?short_form="
      }
      excluded_target_terms: [
        "TEC"
        "TECS"
        "Tec"
        "tec"
        "'"
        "("
        ")"
        "-"
        "-S"
        "S"
        "S-"
        "SS"
        "SSS"
        "Ss"
        "Ss-"
        "s"
        "s-"
        "ss"
        "U3"
        "U6"
        "u6"
        "SNORA70"
        "U2"
        "U8"
      ]
      # The following are the relevant sections for disease/target associations as described in PMID28587637
      sections_of_interest: [
        "title"
        "abstract"
        "intro"
        "case"
        "figure"
        "table"
        "discuss"
        "concl"
        "results"
        "appendix"
        "other"
      ]
      print_metrics: true
    }
    embedding: {
      model_configuration: {
        window_size: 10
        num_partitions: 16
        max_iter: 3
        min_count: 1
        step_size: 0.02
      }
    }
  }

  target_engine: {
    input: {
      targets: ${steps.target.output.target}
      molecule: ${steps.drug.output.drug}
      mechanism_of_action: ${steps.drug.output.mechanism_of_action}
      mouse_phenotypes: {
        format: "parquet"
        path: ${common.path}"/output/mouse_phenotype"
      }
      hpa_data: {
        format: "json"
        path: ${common.path}"/input/target_engine/proteinatlas.json.gz"
      }
      uniprot_slterms: {
        format: "csv"
        path: ${common.path}"/input/target_engine/uniprot_locations.tsv.gz"
        options: [
          { k: "sep",    v: "\t" }
          { k: "header", v: true }
        ]
      }
      mouse_pheno_scores: {
        format: "csv"
        path: ${common.path}"/input/target_engine/mouse_pheno_scores.csv"
        options: [
          { k: "sep",         v: ","  }
          { k: "header",      v: true }
          { k: "inferSchema", v: true }
        ]
      }
    }
    output: {
      target_engine: {
        format: ${common.output_format}
        path: ${common.output_path}"/output/target_prioritisation"
      }
    }
  }
}
